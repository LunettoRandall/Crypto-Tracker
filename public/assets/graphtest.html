<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment-with-locales.min.js"></script>
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.red-yellow.min.css" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css" type="text/css"/>
    <title>Title</title>
</head>

<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--drawer mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <!-- Title -->
                <span class="mdl-layout-title">Title</span>
                <!-- Add spacer, to align navigation to the right -->
                <div class="mdl-layout-spacer"></div>
                <!-- Navigation -->
                <nav class="mdl-navigation">
                    <a class="mdl-navigation__link" href="/">Home</a>
                    <a class="mdl-navigation__link" href="/">Link</a>
                </nav>
            </div>
        </header>
        <!---        DRAWER         -->
        <div class="mdl-layout__drawer">
            <span class="mdl-layout-title">Title</span>
            <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="/">Home</a>
                <a class="mdl-navigation__link" href="/">Link</a>
            </nav>
        </div>
        <main class="mdl-layout__content ">
            <div class="page-content">
                <h1 id="main-headers">Track your Coin</h1>
                <div class="mdl-grid">
                    <div class="mdl-cell mdl-cell--12-col mdl-cell--8-col-tablet mdl-cell--6-phone">
                        <!-- ************************************************************************************** -->
                        <!-- <form> -->
                        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option1">
                            <input type="radio" id="option1" name="time" class="mdl-radio__button" value="1 Year">
                            <span class="mdl-radio__label">1 Year</span>
                        </label>
                        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option2">
                            <input type="radio" id="option2" name="time" class="mdl-radio__button" value="6 Months">
                            <span class=" mdl-radio__label ">6 Months</span>
                        </label>
                        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect " for="option3">
                            <input type="radio" id="option3" name="time" class="mdl-radio__button" value="3 Months">
                            <span class="mdl-radio__label">3 Months</span>
                        </label>
                        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option4">
                            <input type="radio" id="option4" name="time" class="mdl-radio__button" value="1 Month">
                            <span class="mdl-radio__label">1 Month</span>
                        </label>
                        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option5">
                            <input type="radio" id="option5" name="time" class="mdl-radio__button" value="1 Week">
                            <span class="mdl-radio__label">1 Week</span>
                        </label>
                        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option6">
                            <input type="radio" id="option6" name="time" class="mdl-radio__button" value="1 Day">
                            <span class="mdl-radio__label">1 Day</span>
                        </label>
                        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option7">
                            <input type="radio" id="option7" name="time" class="mdl-radio__button" value="3 Hours">
                            <span class="mdl-radio__label">3 Hours</span>
                        </label>
                        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option8">
                            <input type="radio" id="option8" name="time" class="mdl-radio__button" value="1 Hour">
                            <span class="mdl-radio__label">1 Hour</span>
                        </label>
                        <!--          <button class='mdl-button mdl-js-button mdl-buttonraised mdl-js-ripple-effect' id='survey-start-btn'> Submit </button> -->
                        <!-- </form> -->
                        <div id="chart_div" style="width: 900px; height: 500px"></div>
                        <!-- ************************************************************************************ -->
                        <h2 id="main-headers">Bitcoin</h2>
                        <div class="wide-card mdl-card mdl-shadow--8dp">
                            <div class="mdl-card__title">
                                <h2 class="mdl-card__title-text"></h2>
                            </div>
                            <div class="mdl-card__supporting-text" id="currency">
                            </div>
                            <div class="mdl-card__actions mdl-card--border">
                                <br>
                            </div>
                        </div>
                        <br>
                    </div>
                </div>
            </div>
    </div>
    </main>
    </div>
    <!-- // COPY SCRIPT INTO EXTERNAL FILE, AND UNCOMMENT WHEN READY TO MERGE -->
    <!-- <script type="text/javascript" href="./javascript/stockgraph.js"></script> -->
    <script type="text/javascript">
    var chartPointArray = [];
    var BTCprice = 0;
    var USDprice = 0;

    $(document).ready(function() {
        var defaultView = true;

        function get_tblcurrency() {
            $.get("/tblcurrency", function(data) {
                // Grabbing data from out database
                // console.log(data)
                createChartPoints(data);
                // Updates the graph in real time so long as we are on the default viewing
                if (defaultView === true) {
                    google.charts.load('current', {
                        packages: ['corechart', 'line']
                    });
                    google.charts.setOnLoadCallback(drawLogScales);
                }
            });
        }
        get_tblcurrency();
        setInterval(get_tblcurrency, 10000)
            //  A feature that updates the graph in real time

        function createChartPoints(data) {
            chartPointArray = [];
            // Formating that data into something Google Material Chart will understand...
            for (i = 0; i < data.length; i++) {
                var dbTime = data[i].moment_tstamp.split("+");
                var date = dbTime[0].split("-");
                var time = dbTime[1].split(":");
                var timeArray = date.concat(time);
                var chartPoint = {
                    time: timeArray,
                    price: data[i].USDprice
                };
                // ...and pusing it into an array...
                chartPointArray.push(chartPoint)
            }
            // We can see our array of new chart Points
            // console.log(chartPointArray)
        }
        // ************************************************************************************
        // Might need these lines of code 
        // ************************************************************************************
        // google.charts.load('current', {
        //     packages: ['corechart', 'line']
        // });
        // google.charts.setOnLoadCallback(drawLogScales);
        // ************************************************************************************
        // END
        // ************************************************************************************


        function drawLogScales() {
            var data = new google.visualization.DataTable();
            data.addColumn('datetime', 'Date');
            data.addColumn('number', 'BTC/USD');

            // We are taking those chart points and turning them into a format that Google's Material Chart can understand in order
            // to turn into rows
            for (i = 0; i < chartPointArray.length; i++) {
                var newPoint = chartPointArray[i];
                data.addRows([
                    [new Date(newPoint.time[0], newPoint.time[1] - 1, newPoint.time[2], newPoint.time[3], newPoint.time[4]), newPoint.price]
                ])
            }
            // ************************************************************************************
            // VARIABLES FOR GRAPH SCALING
            // ************************************************************************************
            var now = moment().format("YYYY-MM-DD+HH:mm:ss");
            var nowArray = formatTime(now);
            var then = moment().subtract(1, "Hours").format("YYYY-MM-DD+HH:mm:ss");
            var maxDate = new Date(nowArray[0], nowArray[1] - 1, nowArray[2], nowArray[3], nowArray[4]);
            var thenArray = formatTime(then);
            // ************************************************************************************
            // DEFAULT GRAPH SCALE
            // ************************************************************************************
            var options = {
                hAxis: {
                    title: 'Time (Last Hour)',
                    logScale: false,
                    format: "hh:mma",
                    viewWindow: {
                        min: new Date(thenArray[0], thenArray[1] - 1, thenArray[2], thenArray[3], thenArray[4]),
                        max: maxDate
                    }
                },
                vAxis: {
                    title: 'Price (USD)',
                    logScale: true,
                    format: "currency"
                },
                colors: ['#30d138']
            };

            var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            chart.draw(data, options)
                // ************************************************************************************
                // This function updates the chart when clicking a certain timespan
                // ************************************************************************************

            $("input").click(function() {

                var now = moment().format("YYYY-MM-DD+HH:mm:ss");
                var nowArray = formatTime(now);
                var maxDate = new Date(nowArray[0], nowArray[1] - 1, nowArray[2], nowArray[3], nowArray[4]);
                var selected = $(this).attr("value");

                switch (selected) {
                    case "1 Hour":
                        var then = moment().subtract(1, "Hour").format("YYYY-MM-DD+HH:mm:ss");
                        var timeArray = formatTime(then);
                        options.hAxis.format = "hh:mma";
                        options.hAxis.title = "Time (Last Hour)";
                        createTable(options, timeArray, maxDate, chart, data);
                        defaultView = true;
                        break;
                    case "3 Hours":
                        var then = moment().subtract(3, "Hours").format("YYYY-MM-DD+HH:mm:ss");
                        var timeArray = formatTime(then);
                        options.hAxis.format = "hh:mma";
                        options.hAxis.title = "Time (Last 3 Hours)";
                        createTable(options, timeArray, maxDate, chart, data);
                        defaultView = false;
                        break;
                    case "1 Day":
                        var then = moment().subtract(1, "Days").format("YYYY-MM-DD+HH:mm:ss");
                        var timeArray = formatTime(then);
                        options.hAxis.format = "MMM-d hha";
                        options.hAxis.title = "Time (Last Day)";
                        createTable(options, timeArray, maxDate, chart, data);
                        break;
                    case "1 Week":
                        var then = moment().subtract(1, "Weeks").format("YYYY-MM-DD+HH:mm:ss");
                        var timeArray = formatTime(then);
                        options.hAxis.format = "MMM-d";
                        options.hAxis.title = "Time (Last Week)";
                        createTable(options, timeArray, maxDate, chart, data);
                        break;
                    case "1 Month":
                        var then = moment().subtract(1, "Months").format("YYYY-MM-DD+HH:mm:ss");
                        var timeArray = formatTime(then);
                        options.hAxis.format = "MMM-d";
                        options.hAxis.title = "Time (Last Month)";
                        createTable(options, timeArray, maxDate, chart, data);
                        break;
                    case "3 Months":
                        var then = moment().subtract(3, "Months").format("YYYY-MM-DD+HH:mm:ss");
                        var timeArray = formatTime(then);
                        options.hAxis.format = "MMM-d yyyy";
                        options.hAxis.title = "Time (Last 3 Months)";
                        createTable(options, timeArray, maxDate, chart, data);
                        break;
                    case "6 Months":
                        var then = moment().subtract(6, "Months").format("YYYY-MM-DD+HH:mm:ss");
                        var timeArray = formatTime(then);
                        options.hAxis.format = "MMM yyyy";
                        options.hAxis.title = "Time (Last 6 Months)";
                        createTable(options, timeArray, maxDate, chart, data);
                        break;
                    case "1 Year":
                        var then = moment().subtract(1, "Years").format("YYYY-MM-DD+HH:mm:ss");
                        var timeArray = formatTime(then);
                        options.hAxis.format = "MMM yyyy";
                        options.hAxis.title = "Time (Last Year)";
                        createTable(options, timeArray, maxDate, chart, data);
                        break;
                }
            })
        }
        // ************************************************************************************
        // Formating the time into a format that Google Material Charts can understand
        // ************************************************************************************
        function formatTime(thenTime) {
            var dbTime = thenTime.split("+");
            var date = dbTime[0].split("-");
            var time = dbTime[1].split(":");
            var timeArray = date.concat(time);
            // console.log(timeArray)
            return timeArray
        }
        // ************************************************************************************
        // Creates the table based off user input
        // ************************************************************************************
        function createTable(options, timeArray, maxDate, chart, data) {
            options.hAxis.viewWindow.min = new Date(timeArray[0], timeArray[1] - 1, timeArray[2], timeArray[3], timeArray[4]);
            options.hAxis.viewWindow.max = maxDate;
            chart.draw(data, options);
        }
        // ************************************************************************************

        // ************************************************************************************
        // UNCOMMENT THIS TO SEE THE PRICE OF BTC IN REAL TIME
        // ************************************************************************************
        // function priceUSD() {
        //     $.get("https://min-api.cryptocompare.com/data/price?fsym=USD&tsyms=BTC,ETH,EUR", function(data) {
        //         USDprice = data.BTC;
        //         console.log(USDprice);
        //         $("#currency").append(`USD/BTC: $${USDprice}<br>`)
        //     });
        // }
        // function priceBTC() {
        //     $.get("https://min-api.cryptocompare.com/data/price?fsym=BTC&tsyms=USD,ETH,EUR", function(data) {
        //         BTCprice = data.USD;
        //         console.log(BTCprice)
        //         $("#currency").append(`BTC/USD: $${BTCprice}`)
        //     });
        // }
        // priceUSD();
        // priceBTC();


        // ************************************************************************************
        // END
        // ************************************************************************************
    })
    </script>
</body>

</html>
